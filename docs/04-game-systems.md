# 04. 게임 시스템

## 턴 시스템

- **턴 제한**: 120턴 (`TURN_LIMIT`)
- 턴마다 5-Phase 회의 시스템 실행

### 턴 진행 — 5-Phase 회의 시스템

```
Phase 1: 상태 보고 (자동, API 1회 — Phase 3과 합산)
  ├─ 4인 참모가 각 분야 현황 보고 (status_reports)
  ├─ 회의 대사 (council_messages) 애니메이션 표시
  └─ state_changes 즉시 적용

Phase 2: 군주 토론 (AP 1 소비/발언, API 0~N회)
  ├─ 참모 발언 클릭 → 쓰레드 대화 (지정 참모 우선 응답)
  ├─ 자유 입력 → AI 반응 (callReactionLLM)
  └─ "다음" 버튼 → Phase 3

Phase 3: 계획 보고 (자동, API 0회 — Phase 1과 함께 생성)
  ├─ 참모별 계획 발표 (plan_reports)
  └─ 기대 포인트 변동 표시

Phase 4: 군주 피드백 (AP 1 소비/발언, API 0~N회)
  ├─ 계획에 대한 피드백/boost (callReactionLLM)
  └─ "실행" 버튼 → Phase 5

Phase 5: 턴 실행 (자동)
  ├─ 계획 실행 + NPC 턴 (API 1회, 배치 처리)
  ├─ advanceWorldTurn(): 포인트 충전, 부상 회복
  ├─ checkGameEnd(): 승패 판정
  ├─ autoSave(): Firebase 자동 저장
  └─ Phase 1 복귀
```

---

## 참모 시스템 (Phase 1~4)

### 4인 참모

| 참모 | 역할 | 아이콘 | 성격 |
|------|------|--------|------|
| 제갈량 | 전략 | 🪶 | 신중, 전략적, 존댓말, 고사 인용, 스킬/장기 전략 담당 |
| 관우 | 군사 | ⚔️ | 명예, 직설적, 군사적 해결 선호, 징병/훈련/전투 담당 |
| 방통 | 외교 | 🦅 | 자부심, 계략에 능함, 외교 전략과 이간계, 동맹 담당 |
| 미축 | 내정 | 💰 | 보수적, 경제 중시, 수치 근거, 재정/시설 관리 담당 |

### 참모 상태

- **충성도** (loyalty, 0~100): 참모의 주공에 대한 충성심
- **열정** (enthusiasm, 0~100): 업무 의욕, 행동 품질에 영향
- 매 턴 AI가 `advisor_updates`로 변동값 반환

### 쓰레드 대화

- 참모 발언을 클릭하면 해당 주제로 쓰레드 대화 시작
- 쓰레드 내 답장: 지정된 참모가 **먼저** 응답 (프롬프트 + 코드 레벨 강제)
- 다른 참모의 첨언은 이후에 따라옴
- `Record<number, ThreadMessage[]>` 구조 (메시지 인덱스 → 쓰레드)

---

## 포인트 시스템

### 5종 포인트

| 포인트 | 약칭 | 설명 | 충전/소비 |
|--------|------|------|-----------|
| 행동 포인트 | AP | 발언 기회 | 매턴 이월(50%) + 충전 |
| 전략 포인트 | SP | 스킬 트리 해금 | 매턴 소량 자동 충전 |
| 군사 포인트 | MP | 전투력 = troops × training × morale | 모병/훈련으로 증가 |
| 내정 포인트 | IP | 시설/모병/훈련 비용 | 시설 레벨 기반 충전 (상한 존재) |
| 외교 포인트 | DP | 외교 행동 비용 | 매턴 소량 자동 충전 |

### AP 이월

- 매턴 AP = `floor(이전 AP × 0.5) + ap_regen`
- AP가 ap_max를 초과하지 않음

### MP 산출

```
MP = mp_troops × mp_training × mp_morale
```

- `mp_troops`: 병력 수 (모병으로 증가, 전투로 감소)
- `mp_training`: 훈련도 (0.0~1.0, IP로 훈련)
- `mp_morale`: 사기 (0.8~1.2, 승리/패배로 변동)

### IP 시설 기반

- 매턴 IP 충전: `market_level × 3 + farm_level × 2`
- IP 상한: `ip_cap` (은행 레벨로 증가)
- 시설 업그레이드 비용: `level × BASE_FACILITY_COST`

### DP 자동 충전

- 매턴 DP +1 자동 충전
- `dp_bonus` 스킬로 충전 효율 증가

### 경험치 시스템

> 상수: `gameConstants.ts`

| 항목 | 값 | 설명 |
|------|------|------|
| BASE_XP_TO_LEVEL | 100 | 레벨업 필요 경험치 기본값 |
| XP_PER_AP_SPENT | 15 | AP 1 소비 시 경험치 획득 |
| SP_PER_BATTLE_WIN | 5 | 전투 승리 시 SP 획득 |

- AP를 소비(Phase 2/4 발언)할 때마다 경험치 획득
- 레벨업 시 `deploymentCap` 증가 (`level × 30,000`)

---

## 전투 시스템

> 파일: `lib/game/combatSystem.ts`

### 전투 유형

| 유형 | 설명 | 공격측 배율 | 수비측 배율 |
|------|------|------------|------------|
| 야전 | 평지 전투 | 1.0 | 1.0 |
| 공성 | 성채 공격 | 1.0 (+스킬) | 성채 방어 배율 |
| 수성 | 성채 방어 | 1.0 | 성채 방어 배율 (+스킬) |

### 전투력 계산

```
전투력 = MP × 방어 배율
공격측 전투력 - 수비측 전투력 → 양수면 공격측 승리
±10% 랜덤 변동 적용
```

### 배치 상한

- `rulerLevel.deploymentCap` = level × 30,000
- 투입 병력이 배치 상한을 초과할 수 없음

### 전투 결과

- 손실률: 기본 20%, 최대 50%
- 부상 전환: 사망자의 70%가 부상병으로 전환
- 부상 회복: `WOUND_RECOVERY_TURNS` (5턴)에 걸쳐 병력 복귀
- 성채 점령: **공성** 승리 시만 해당 성채 소유권 이전

---

## 외교 시스템

> 파일: `lib/game/diplomacySystem.ts`

### 관계 점수

-10 ~ +10 스케일. `scoreToLabel()`로 변환:

| 점수 범위 | 라벨 |
|-----------|------|
| 7 이상 | 동맹 |
| 3 ~ 6 | 우호 |
| -3 ~ 2 | 중립 |
| -7 ~ -4 | 적대 |
| -8 이하 | 전쟁 |

### 외교 행동

DP를 소비하여 관계 변동. AI가 외교 행동을 제안/실행.

---

## 성채 시스템

> 파일: `constants/castles.ts`

### 배치 구조

~34개 성채가 삼각형 라인으로 배치:

```
유비(신야) ←── liu_cao 라인 ──→ 조조(허창)
  ↓                                ↑
liu_sun 라인               sun_cao 라인
  ↓                                ↑
손권(건업) ←────────────────────────┘
```

### 성채 등급

| 등급 | 방어 배율 | 예시 |
|------|-----------|------|
| 본성 | 3.0 | 신야, 허창, 건업 |
| 요새 | 2.0~2.5 | 양양, 업, 합비, 강릉 |
| 일반 | 1.5 | 완, 서주, 진류 등 |

### 초기 세력 영토

| 세력 | 성채 수 | 본성 |
|------|---------|------|
| 유비 | 2 | 신야 |
| 조조 | 24 | 허창 |
| 손권 | 9 | 건업 |

---

## 스킬 시스템

> 파일: `constants/skills.ts`

SP를 소비하여 영구 패시브 효과 해금.

| 카테고리 | 효과 예시 |
|----------|----------|
| AP 계열 | AP 자동 충전 증가 |
| MP 계열 | 매턴 병력 자동 증가 |
| IP 계열 | IP 충전량 보너스 |
| 전투 계열 | 공성/수성 버프 |

선행 스킬 조건: `prerequisites` 충족 필요.

---

## 승리/패배 조건

> 파일: `lib/game/victorySystem.ts`

### 승리

| 조건 | 설명 |
|------|------|
| 천하통일 | 모든 적 세력의 **본성** 함락 |

### 패배

| 조건 | 설명 |
|------|------|
| 멸망 | 자기 **본성** 함락됨 |

본성 목록: 유비=신야, 조조=허창, 손권=건업 (`CAPITAL_CASTLES`)
