# 04. 게임 시스템

## 턴 시스템

### 시간 구조

- **1턴 = 1개월**, 3월(봄) 시작
- 12개월 = 4계절 = 1년
- 계절: 봄(3~5월) → 여름(6~8월) → 가을(9~11월) → 겨울(12~2월)

### 턴 진행 — 4단계 Phase 시스템

```
Phase 0: 정세 브리핑 (도입/상황 인식)
  ├─ 첫 턴: 제갈량 도입 서사 (고정 메시지, 토큰 미사용)
  ├─ 긴급 상황: BriefingPanel 표시 → 감정 방향 선택
  └─ 평상시: 자동 스킵 → Phase 1 직행

Phase 1: 참모 회의 (API 1회)
  ├─ 5인 참모가 자율적으로 업무 수행
  ├─ 회의 대사 (council_messages) 애니메이션 표시
  ├─ 자율 행동 보고 (auto_actions) + 상태 즉시 적용
  └─ 결재 요청 (approval_requests) 0~2개

Phase 2: 플레이어 입력 (선택적 API 0~1회)
  ├─ 결재 승인/거부 → AI 결과 보고
  ├─ 참모 발언 클릭 → 쓰레드 대화 (지정 참모 우선 응답)
  ├─ 자유 입력 → AI 반응
  └─ "다음 턴" 버튼 → Phase 3

Phase 3: NPC 턴 + 턴 전진 (API 1회)
  ├─ 3개 NPC 세력 행동 (배치 AI / 결정론적 폴백)
  ├─ advanceWorldTurn(): 자원 계산, 월/계절 갱신, 조약 감소
  ├─ checkGameEnd(): 승패 판정
  ├─ autoSave(): Firebase 자동 저장
  └─ Phase 0으로 복귀
```

### 계절별 식량 배율

| 계절 | 배율 | 아이콘 |
|------|------|--------|
| 봄 | ×1.5 | 🌸 |
| 여름 | ×1.0 | ☀️ |
| 가을 | ×1.5 | 🍂 |
| 겨울 | ×0.5 | ❄️ |

---

## 참모 회의 시스템 (Phase 1~2)

> **핵심 변경**: A/B/C 선택지 → 참모 자율 행동 + 결재 시스템

### 5인 참모

| 참모 | 역할 | 아이콘 | 성격 |
|------|------|--------|------|
| 제갈량 | 총괄 | 🪶 | 신중, 전략적, 존댓말, 고사 인용 |
| 관우 | 군사 | ⚔️ | 명예, 직설적, 군사적 해결 선호 |
| 미축 | 내정 | 💰 | 보수적, 경제 중시, 수치 근거 |
| 간옹 | 외교 | 🤝 | 유머, 설득력, 외교적 해결 선호 |
| 조운 | 첩보 | 🔍 | 충직, 균형, 정보 분석, 간결 보고 |

특수 캐릭터: **장비** (🔥) — 정식 참모가 아니지만 가끔 회의에 끼어들어 단순 명쾌한 의견을 냄.

### 참모 상태

- **충성도** (loyalty, 0~100): 참모의 주공에 대한 충성심
- **열정** (enthusiasm, 0~100): 업무 의욕, 행동 품질에 영향
- 매 턴 AI가 `advisor_updates`로 변동값 반환

### 자율 행동 (auto_actions)

참모가 자기 역할에 맞는 행동을 자율적으로 수행하고 결과를 보고.

```json
{
  "advisor": "미축",
  "role": "내정",
  "action": "세금 징수",
  "result": "금 320 확보",
  "state_changes": { "gold_delta": 320 }
}
```

### 결재 요청 (approval_requests)

중대 사안은 플레이어에게 결재를 요청 (0~2개/턴).

```json
{
  "id": "req_01",
  "advisor": "관우",
  "subject": "대규모 모병 계획",
  "description": "신야성에서 1만 병력 추가 모집",
  "cost": { "gold_delta": -3000, "troops_delta": 10000 },
  "benefit": "군사력 증강",
  "urgency": "important"
}
```

| 긴급도 | 의미 | 방치 시 처리 |
|--------|------|------------|
| routine | 일상적 | 자동 승인 |
| important | 중요 | 50% 자율 판단 |
| critical | 긴급 | 보류 |

### 쓰레드 대화

- 참모 발언을 클릭하면 해당 주제로 쓰레드 대화 시작
- 쓰레드 내 답장: 지정된 참모가 **먼저** 응답 (프롬프트 + 코드 레벨 강제)
- 다른 참모의 첨언은 이후에 따라옴
- Record<number, ThreadMessage[]> 구조 (메시지 인덱스 → 쓰레드)

---

## 정세 브리핑 시스템 (Phase 0)

> 파일: `lib/game/situationDetector.ts`

### 긴급 상황 (isUrgent=true)

우선순위 순:

| 유형 | 감지 키워드 | 대응 |
|------|------------|------|
| 침공 (invasion) | 침공, 공격, 선전포고, 전쟁 | 감정 방향 4개 선택지 |
| 도시 상실 (city_lost) | 함락, 상실, 빼앗 | 감정 방향 4개 선택지 |
| 기근 (famine) | 식량 < 1000 또는 금 < 500 | 감정 방향 4개 선택지 |
| 배신 (betrayal) | 파기, 배신, 반란 | 감정 방향 4개 선택지 |
| 장수 이탈 (general_defect) | 이탈, 탈영, 투항 | 감정 방향 4개 선택지 |

### 감정 방향 (EmotionalDirective)

긴급 상황 시 유비의 반응을 선택:

| 톤 | 예시 대사 | 효과 |
|----|----------|------|
| aggressive | "감히! 용서할 수 없다!" | 공격적 방향 — 관우 적극, 미축 걱정 |
| cooperative | "큰일이군. 힘을 합쳐야..." | 협력적 토론 |
| delegating | "경들에게 맡기겠소" | 참모 재량 위임 |
| anxious | "어찌하면 좋겠소..." | 걱정 — 신중한 방향 |

### 게임 시작 도입 서사

첫 턴에만 실행되는 제갈량의 4단계 고정 서사 (API 미사용):

1. 삼고초려 은혜 + 시대 소개
2. 천하 정세 (각 세력 병력/도시, 조조-원소 전쟁)
3. 유비군 현황 (도시, 병력, 장수)
4. 첫 참모 회의 개시 선언

속도: 첫 대사 즉시 표시, 속도 배율 0.7, 이후 매번 20%씩 빠르게 (speedMultiplier: 0.7, speedDecay: 0.8)

---

## 자원 시스템

### 4대 자원

| 자원 | 설명 | 수입원 |
|------|------|--------|
| 금 (gold) | 범용 화폐 | 도시 상업 × 인구 / 1000 |
| 식량 (food) | 군 유지 | 도시 농업 × 인구 / 500 × 계절배율 |
| 병력 (totalTroops) | 군사력 | 모병 행동으로 증가 |
| 민심 (popularity) | 통치 안정 | AI 행동에 따라 변동 |

### 식량 소모

- 병력 1명당 턴당 식량 0.03 소모 (`TROOP_FOOD_COST_PER_UNIT`)
- 순 식량 = 생산량 - 소모량 (음수 가능)

---

## 전투 시스템

> 파일: `lib/game/combatSystem.ts`

### 전투 종류

| 종류 | 설명 |
|------|------|
| 야전 (field) | 평지 전투, 무력 중심 |
| 공성전 (siege) | 도시 공격, 지력 중심, 수비 ×1.3 |
| 매복 (ambush) | 기습, 지력 중심 |

### 전투력 계산

```
battlePower = 장수 보정 + 병력 × 0.001 + 지형 보정 + 랜덤(±15%)
```

장수 능력치 가중합 (전투 종류별):

| 종류 | 무력 | 지력 | 통솔 |
|------|------|------|------|
| 야전 | 60% | 10% | 30% |
| 공성전 | 30% | 40% | 30% |
| 매복 | 20% | 60% | 20% |

### 전투 결과

- 승패: 전투력 비교
- 손실: 패자 병력 15~35%, 승자 5~15%
- 포로: 패자 장수 15% 확률로 포획
- 도시 점령: 공성전 승리 시 해당 도시 이전

---

## 외교 시스템

> 파일: `lib/game/diplomacySystem.ts`

### 관계 단계

| 관계 | 점수 범위 |
|------|-----------|
| 동맹 (alliance) | 60 이상 |
| 우호 (friendly) | 20 ~ 59 |
| 중립 (neutral) | -19 ~ 19 |
| 적대 (hostile) | -59 ~ -20 |
| 전쟁 (war) | -60 이하 |

### 외교 행동 6종

| 행동 | 요구 관계 | 성공 시 효과 |
|------|-----------|-------------|
| 동맹 제안 | 30 이상 | 군사동맹 10턴, 관계 +15 |
| 교역 제안 | -30 이상 | 교역 5턴, 관계 +10 |
| 불가침 조약 | -10 이상 | 불가침 8턴, 관계 +5 |
| 선전포고 | 없음 | 관계 -50, 전쟁 상태 |
| 공물 요구 | 없음 | 공물 3턴 (병력/성격 기반 성공률) |
| 관계 개선 | 없음 | 관계 +5~15 (항상 성공) |

---

## 이벤트 시스템

> 파일: `lib/game/eventSystem.ts`, `constants/events.ts`

### 랜덤 이벤트 5종

| 이벤트 | 조건 | 확률 |
|--------|------|------|
| 조조의 남침 경고 | 턴 3 이상 | 30% |
| 유랑민 유입 | 민심 50 이상 | 35% |
| 메뚜기떼 | 여름 | 25% |
| 상인 방문 | 상업 45+ 도시 보유 | 40% |
| 장수 불만 | 충성도 95 미만 장수 | 30% |

---

## 승리/패배 조건

> 파일: `lib/game/victorySystem.ts`

### 승리

| 조건 | 설명 |
|------|------|
| 천하통일 | 전체 20개 도시 모두 보유 |
| 천명 | 14개 이상 도시(70%) + 민심 90 이상 |

### 패배

| 조건 | 설명 |
|------|------|
| 멸망 | 보유 도시 0개 |
| 파산 | 금, 식량, 병력 모두 0 |
