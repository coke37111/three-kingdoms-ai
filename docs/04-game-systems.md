# 04. 게임 시스템

## 턴 시스템

### 시간 구조

- **1턴 = 1개월**, 3월(봄) 시작
- 12개월 = 4계절 = 1년
- 계절: 봄(3~5월) → 여름(6~8월) → 가을(9~11월) → 겨울(12~2월)

### 턴 진행 순서

```
1. 플레이어 행동 (AI 제갈량과 대화/선택)
2. 상태 변경 적용 (applyPlayerChanges)
3. NPC 세력 행동 (processNPCTurns)
4. 턴 전진 (advanceWorldTurn)
   - 모든 세력 자원 계산
   - 월/계절/년 갱신
   - 조약 기간 감소
   - 태스크 기간 감소
5. 게임 종료 조건 체크
6. 자동 저장
7. 새 턴 상황 보고 (AI)
```

### 계절별 식량 배율

| 계절 | 배율 | 아이콘 |
|------|------|--------|
| 봄 | ×1.5 | 🌸 |
| 여름 | ×1.0 | ☀️ |
| 가을 | ×1.5 | 🍂 |
| 겨울 | ×0.5 | ❄️ |

---

## 자원 시스템

### 4대 자원

| 자원 | 설명 | 수입원 |
|------|------|--------|
| 금 (gold) | 범용 화폐 | 도시 상업 × 인구 / 1000 |
| 식량 (food) | 군 유지 | 도시 농업 × 인구 / 500 × 계절배율 |
| 병력 (totalTroops) | 군사력 | 모병 행동으로 증가 |
| 민심 (popularity) | 통치 안정 | AI 행동에 따라 변동 |

### 식량 소모

- 병력 1명당 턴당 식량 0.2 소모
- 순 식량 = 생산량 - 소모량 (음수 가능)

### 자원 계산 함수

```
calcFactionResources(faction, season) → { goldIncome, foodProduced, foodConsumed }
```

각 세력이 보유한 모든 도시의 상업/농업 합산 후 계절 배율 적용.

---

## 전투 시스템

> 파일: `lib/game/combatSystem.ts`

### 전투 종류

| 종류 | 설명 |
|------|------|
| 야전 (field) | 평지 전투, 무력 중심 |
| 공성전 (siege) | 도시 공격, 지력 중심, 수비 ×1.3 |
| 매복 (ambush) | 기습, 지력 중심 |

### 전투력 계산

```
battlePower = 장수 보정 + 병력 × 0.001 + 지형 보정 + 랜덤(±15%)
```

**장수 능력치 가중합 (전투 종류별):**

| 종류 | 무력 | 지력 | 통솔 |
|------|------|------|------|
| 야전 | 60% | 10% | 30% |
| 공성전 | 20% | 40% | 40% |
| 매복 | 30% | 50% | 20% |

### 전투 결과

- 승패: 전투력 비교
- 손실: 패자 병력 15~35%, 승자 5~15%
- 포로: 패자 장수 15% 확률로 포획
- 도시 점령: 공성전 승리 시 해당 도시 이전

---

## 외교 시스템

> 파일: `lib/game/diplomacySystem.ts`

### 관계 단계

| 관계 | 점수 범위 |
|------|-----------|
| 동맹 (alliance) | 60 이상 |
| 우호 (friendly) | 20 ~ 59 |
| 중립 (neutral) | -19 ~ 19 |
| 적대 (hostile) | -59 ~ -20 |
| 전쟁 (war) | -60 이하 |

### 외교 행동 6종

| 행동 | 요구 관계 | 성공 시 효과 |
|------|-----------|-------------|
| 동맹 제안 | 30 이상 | 군사동맹 10턴, 관계 +15 |
| 교역 제안 | -30 이상 | 교역 5턴, 관계 +10 |
| 불가침 조약 | -10 이상 | 불가침 8턴, 관계 +5 |
| 선전포고 | 없음 | 관계 -50, 전쟁 상태 |
| 공물 요구 | 없음 | 공물 3턴 (병력/성격 기반 성공률) |
| 관계 개선 | 없음 | 관계 +5~15 (항상 성공) |

### 조약 시스템

- 조약은 남은 턴(turnsRemaining) 관리
- 매 턴 1씩 감소, 0이 되면 자동 만료
- 조약 종류: 교역(trade), 불가침(non_aggression), 군사동맹(military_alliance), 공물(tribute)

---

## 이벤트 시스템

> 파일: `lib/game/eventSystem.ts`, `constants/events.ts`

### 랜덤 이벤트 5종

| 이벤트 | 조건 | 확률 |
|--------|------|------|
| 조조의 남침 경고 | 턴 3 이상 | 30% |
| 유랑민 유입 | 민심 50 이상 | 35% |
| 메뚜기떼 | 여름 | 25% |
| 상인 방문 | 상업 45+ 도시 보유 | 40% |
| 장수 불만 | 충성도 95 미만 장수 | 30% |

이벤트 발생 시 태스크(GameTask)로 등록되며, 긴급도(urgency)와 남은 턴(turnsLeft)이 부여됨.

---

## 승리/패배 조건

> 파일: `lib/game/victorySystem.ts`

### 승리

| 조건 | 설명 |
|------|------|
| 천하통일 | 전체 20개 도시 모두 보유 |
| 천명 | 14개 이상 도시(70%) + 민심 90 이상 |

### 패배

| 조건 | 설명 |
|------|------|
| 멸망 | 보유 도시 0개 |
| 파산 | 금, 식량, 병력 모두 0 |

승패 판정 시 통계 수집: 총 턴 수, 보유 도시, 장수, 병력, 금, 식량 등.

---

## NPC 의사결정

### AI 기반 (우선)

- `buildFactionAIPrompt()`로 3개 NPC 세력의 상황을 한 프롬프트에 묶어 전달
- AI가 각 세력별 행동(actions)과 요약(summary) 반환
- 행동 종류: 개발(develop), 모병(recruit), 공격(attack), 외교(diplomacy), 방어(defend), 대기(wait)

### 결정론적 폴백 (AI 실패 시)

- 기본 행동: 개발 (안전한 선택)
- 금 +500, 식량 +1000, 인구 +2000 (전 도시)
- NPC 턴 알림에 "(AI 응답 없음, 기본 행동)" 표시

### 세력별 성격

| 세력 | 공격성 | 외교 | 개발 | 모험 |
|------|--------|------|------|------|
| 유비 | 30 | 70 | 80 | 40 |
| 조조 | 80 | 50 | 60 | 70 |
| 손권 | 50 | 60 | 70 | 50 |
| 원소 | 60 | 40 | 50 | 30 |
