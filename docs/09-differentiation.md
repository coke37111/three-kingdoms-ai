# 차별점 및 혁신 요소

## 개요

이 프로젝트는 단순한 "텍스트 기반 게임"이 아닌 **AI 네이티브 게임**입니다. LLM(Large Language Model)이 게임의 중심에 있으며, 전통적인 게임에서 개발자가 미리 설계하는 요소들을 AI가 실시간으로 생성합니다.

**AI 네이티브 게임의 정의**: LLM을 단순한 텍스트 생성기가 아닌 **게임 마스터(Game Master)**로 활용하여, 스토리텔링, 게임 밸런싱, NPC 행동 결정, 선택지 생성, 플레이어와의 대화를 모두 AI가 담당하는 게임입니다.

## 일반 전략 게임과의 차별점

### 1. 완전 AI 기반 게임 마스터 시스템

전통적인 전략 게임은 개발자가 미리 설계한 시나리오와 이벤트를 따라갑니다. 이 게임은 다음과 같이 작동합니다:

- **고정 시나리오 없음**: 모든 상황과 대화가 실시간으로 AI에 의해 생성됩니다
- **동적 선택지 생성**: AI가 현재 게임 상태를 분석하여 2-4개의 전략적 선택지를 제시하며, 각 선택지는 위험도(🔥 위험 높음, ⚖️ 균형잡힘, ✅ 안전함)와 예상 결과를 포함합니다
- **자유 대화 가능**: 제시된 선택지 외에도 자연어로 자유롭게 명령하거나 질문할 수 있습니다

**코드 근거**: `lib/prompts/systemPrompt.ts`의 `buildWorldSystemPrompt()` 함수는 전체 게임 상태를 AI에게 전달하고, AI는 `Choice[]` 형태로 동적 선택지를 생성합니다.

### 2. NPC의 지능적 행동

일반 전략 게임의 AI는 고정된 패턴이나 스크립트를 따릅니다. 이 게임의 NPC는:

- **성격 기반 의사결정**: 각 세력 군주는 고유한 성격(공격성, 외교성, 개발성, 모험성)을 가지며, 이를 기반으로 행동을 결정합니다
  - 조조(cao_cao): 공격적이고 야심찬 확장주의자
  - 손권(sun_quan): 신중하고 방어적인 균형론자
  - 원소(yuan_shao): 명성 중시, 동맹과 외교 선호

- **상황 분석 기반 행동**: NPC는 현재 자원, 군사력, 외교 관계, 다른 세력의 움직임을 종합적으로 분석하여 행동을 결정합니다. 패턴 AI가 아닌 진짜 "생각하는" AI입니다.

- **배치 처리 최적화**: 3개 NPC 세력의 행동을 하나의 API 호출로 동시 처리하여 비용과 시간을 절감합니다.

**코드 근거**: `lib/prompts/factionAIPrompt.ts`의 `buildFactionAIPrompt()` 함수
```typescript
// 각 세력의 성격과 상황을 한번에 전달
export function buildFactionAIPrompt(
  factions: Faction[],
  relations: DiplomaticRelation[],
  turn: number,
  season: Season
): string
```

### 3. 대화 + 게임 메커니즘의 통합

전통 게임은 UI와 게임 로직이 분리되어 있지만, 이 게임은:

- **구조화된 AI 응답**: AI는 자연스러운 대화와 게임 상태 변경을 동시에 JSON 형태로 반환합니다
- **통합된 정보 처리**: `dialogue`, `emotion`, `choices`, `state_changes`를 하나의 응답으로 처리
- **캐릭터 일관성**: 제갈량의 페르소나가 모든 응답에서 유지됩니다

**코드 근거**: `lib/prompts/systemPrompt.ts`의 AI 응답 형식
```json
{
  "dialogue": "주공이시여, 조조가 허창을 노리고 있습니다...",
  "emotion": "concerned",
  "choices": [
    {
      "id": "1",
      "text": "선제 공격으로 조조를 견제하라",
      "risk": "high",
      "preview": "병력 -500, 금 -200 / 조조 관계 -30"
    }
  ],
  "state_changes": {
    "gold": -200,
    "military": -500
  }
}
```

## AI 게임으로서의 차별점

### 1. 캐릭터 일관성 시스템

AI 게임의 가장 큰 도전은 캐릭터 일관성 유지입니다. 이 게임은:

- **시스템 프롬프트로 페르소나 강제**: 제갈량의 성격, 말투, 전문성을 명시적으로 정의
- **감정 표현**: `emotion` 필드를 통해 상황에 맞는 감정 전달 (concerned, confident, thoughtful 등)
- **전략가 역할 유지**: 단순 정보 제공이 아닌 군사적·외교적·경제적 조언 제공

**코드 근거**: `lib/prompts/systemPrompt.ts`의 캐릭터 정의
```typescript
당신은 유비(劉備)의 책사인 제갈량(諸葛亮)입니다.
...
말투는 정중하지만 단호하며, 군사적·외교적·경제적 통찰을 제공합니다.
```

### 2. 천하 정세 기반 조언

일반 AI 조언자는 플레이어 상태만 보지만, 제갈량은:

- **전체 월드 상태 파악**: 4개 세력의 자원, 영토, 군사력, 외교 관계를 모두 고려
- **전략적 시각 제공**: "조조가 강성하니 손권과 동맹하라"와 같은 거시적 조언
- **동적 위협 분석**: 현재 가장 위험한 세력과 기회 요인을 실시간 평가

**코드 근거**: `buildWorldSystemPrompt()`는 `WorldState` 전체를 AI에게 전달
```typescript
export function buildWorldSystemPrompt(
  worldState: WorldState,
  playerFactionId: string
): string {
  // 모든 세력 정보 포함
  // 외교 관계 포함
  // 전체 턴 수와 계절 포함
}
```

### 3. 3단계 Fallback 파싱

AI 출력은 항상 완벽하지 않습니다. 이 게임은 강건한 JSON 파싱 시스템을 갖추었습니다:

1. **1단계**: 정규식으로 ```json 블록 추출
2. **2단계**: 마크다운 코드 블록 추출
3. **3단계**: 전체 텍스트를 JSON으로 시도

**코드 근거**: `lib/api/llmClient.ts`의 `parseAIResponse()`
```typescript
function parseAIResponse(text: string): AIResponse {
  // 1. ```json``` 블록 시도
  const jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/);
  if (jsonMatch) { ... }

  // 2. 일반 코드 블록 시도
  const codeMatch = text.match(/```\s*([\s\S]*?)\s*```/);
  if (codeMatch) { ... }

  // 3. 전체 텍스트 시도
  return JSON.parse(text);
}
```

### 4. 비용 최적화 설계

AI 게임의 가장 큰 장벽은 비용입니다. 이 게임은:

- **대화 히스토리 제한**: 최근 20개 메시지만 유지 (`useChatHistory.ts`)
- **모델 전환 지원**: Claude Sonnet 4.5와 GPT-4o 간 실시간 전환 가능
- **토큰 추적**: 입력/출력 토큰을 별도 추적하여 비용 모니터링
- **배치 처리**: NPC 3개 세력을 한 번의 API 호출로 처리

**코드 근거**: `components/game/GameContainer.tsx`의 토큰 추적
```typescript
const [tokenUsage, setTokenUsage] = useState({
  inputTokens: 0,
  outputTokens: 0,
  turnCount: 0
});
```

### 5. 타이핑 애니메이션 + 감정 표현

몰입감을 위해:

- **타이핑 애니메이션**: AI 응답이 한 글자씩 나타남 (`hooks/useTypewriter.ts`)
- **감정 기반 색상**: 제갈량의 감정에 따라 대화 창 색상 변경
- **리치 텍스트**: 볼드, 이탤릭, 리스트 등 마크다운 렌더링

## 기존 삼국지 게임 비교

| 요소 | 일반 삼국지 게임 | 이 게임 |
|------|-----------------|---------|
| **시나리오** | 고정된 역사 이벤트 | AI가 실시간 생성하는 동적 상황 |
| **조작 방식** | 메뉴/버튼 클릭 | 자연어 대화 + 선택지 |
| **NPC 행동** | 고정 패턴 또는 룰 기반 | 상황 분석 기반 AI 의사결정 |
| **선택지** | 개발자가 미리 작성 | AI가 현재 상태 기반 동적 생성 |
| **확장성** | DLC/패치 필요 | AI 모델 업데이트만으로 개선 |
| **대화** | 스크립트화된 대사 | 자유로운 질문과 명령 가능 |
| **밸런싱** | 개발자가 수동 조정 | AI가 위험도와 결과 자동 평가 |

## 핵심 혁신

### LLM을 "게임 마스터"로 활용

전통적인 게임 개발에서는:
- 개발자가 모든 시나리오를 설계
- 개발자가 NPC 행동 패턴을 프로그래밍
- 개발자가 선택지와 결과를 작성
- 개발자가 밸런싱을 조정

이 게임에서는:
- **AI가 스토리텔링**: 현재 상황을 분석하여 내러티브 생성
- **AI가 게임 밸런싱**: 선택지의 위험도와 보상을 실시간 평가
- **AI가 NPC 행동 결정**: 각 NPC의 성격과 상황을 고려한 결정
- **AI가 선택지 생성**: 플레이어의 상태와 전략적 상황에 맞는 옵션 제시
- **AI가 플레이어와 대화**: 자유로운 질문에 답변하고 조언 제공

## 기술적 근거

### 주요 파일

1. **`lib/prompts/systemPrompt.ts`**
   - 제갈량 캐릭터 정의 및 페르소나 강제
   - 월드 상태 전달 (`buildWorldSystemPrompt`)
   - 응답 형식 정의 (JSON 스키마)

2. **`lib/prompts/factionAIPrompt.ts`**
   - NPC 행동 결정 프롬프트
   - 배치 처리 구조 (3개 세력 동시)
   - 성격 기반 의사결정 가이드

3. **`lib/api/llmClient.ts`**
   - 3단계 JSON 파싱 fallback
   - 에러 핸들링 및 복구
   - 모델별 API 호출 추상화

4. **`components/game/GameContainer.tsx`**
   - 게임 루프 오케스트레이션
   - NPC 턴 처리
   - 토큰 사용량 추적
   - 상태 자동 저장

5. **`hooks/useTypewriter.ts`**
   - 타이핑 애니메이션 구현
   - 속도 조절 (40ms/글자)

6. **`hooks/useWorldState.ts`**
   - 멀티 세력 상태 관리
   - 플레이어/NPC 구분
   - 상태 변경 적용

7. **`hooks/useWorldTurn.ts`**
   - 턴 진행 시스템
   - 자원 계산 (모든 세력)
   - 이벤트 체크

### 데이터 흐름

```
1. 플레이어 선택/입력
   ↓
2. WorldState + 대화 히스토리 수집
   ↓
3. buildWorldSystemPrompt() → LLM 호출
   ↓
4. AI 응답 (JSON) → parseAIResponse()
   ↓
5. state_changes 추출 → applyStateChanges()
   ↓
6. NPC 턴 처리
   - buildFactionAIPrompt() → LLM 호출 (배치)
   - parseNPCResponse() → 각 세력 행동 파싱
   - 행동 실행 (전투, 외교, 자원)
   ↓
7. 턴 진행
   - advanceWorldTurn() → 자원 계산
   - checkEvents() → 랜덤 이벤트
   - advanceTreaties() → 외교 조약 진행
   ↓
8. 승패 조건 체크
   - checkGameEnd()
   ↓
9. 새 상황 보고 생성
   - buildWorldSystemPrompt() → LLM 호출
   - 새로운 선택지 제시
   ↓
10. 자동 저장
    - autoSave() → Firestore
```

### 세력별 AI 페르소나

**조조 (Cao Cao)**
```
성격: 공격성 85, 외교성 40, 개발성 60, 모험성 75
전략: 야심찬 확장주의, 약한 세력 우선 공격
행동 패턴: 군사력 우위시 적극적 침공, 외교는 전술적으로만 활용
```

**손권 (Sun Quan)**
```
성격: 공격성 45, 외교성 70, 개발성 75, 모험성 40
전략: 신중한 균형론, 경제 발전 우선
행동 패턴: 방어적 확장, 동맹 유지, 안정적 성장
```

**원소 (Yuan Shao)**
```
성격: 공격성 60, 외교성 80, 개발성 50, 모험성 50
전략: 명성 중시, 동맹 네트워크 구축
행동 패턴: 외교적 고립 회피, 세력 균형 유지 시도
```

## 결론

이 프로젝트는 **LLM을 게임 디자인의 중심에 배치**한 혁신적 시도입니다.

전통 게임은 "개발자가 설계한 경험"을 플레이어에게 제공하지만, 이 게임은 "AI가 실시간으로 생성하는 경험"을 제공합니다. 이는 단순한 기술적 차이가 아니라, 게임 디자인 패러다임의 근본적 변화입니다.

### 장점
- 무한한 재플레이성 (매번 다른 상황)
- 자연스러운 인터랙션 (자유 대화)
- 지능적인 NPC (실제로 생각하는 AI)
- 빠른 콘텐츠 업데이트 (AI 모델 개선만으로)

### 도전과제
- API 비용 관리
- AI 응답 안정성 확보
- 게임 밸런스 유지 (AI가 너무 쉽거나 어려운 선택지 제시)
- 캐릭터 일관성 유지

하지만 이러한 도전과제는 AI 기술의 발전과 함께 지속적으로 개선될 것이며, 이 게임은 **AI 네이티브 게임**의 가능성을 보여주는 중요한 실험입니다.
